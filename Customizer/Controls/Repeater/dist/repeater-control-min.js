!function(){function e(e){return e&&e.__esModule?e.default:e}var t={};t=jQuery;class i{constructor(i,r,s,a){this.setRowIndex=e=>{this.rowIndex=e,this.container.attr("data-row",e),this.container.data("row",e),this.updateLabel()},this.toggleMinimize=()=>{this.container.toggleClass("minimized"),this.header.find(".dashicons").toggleClass("dashicons-arrow-up dashicons-arrow-down")},this.remove=()=>{this.container.slideUp(300,()=>{this.container.detach()}),this.container.trigger("row:remove",[this.rowIndex])},this.updateLabel=()=>{if("field"===this.label.type){let e=this.container[0].querySelector(`.repeater-field [data-field="${this.label.field}"]`);if(e&&e instanceof HTMLInputElement&&"string"==typeof e.value){let t=e.value;if(""!==t){if(this.control.params.fields[this.label.field]&&this.control.params.fields[this.label.field].type){if("select"===this.control.params.fields[this.label.field].type&&this.control.params.fields[this.label.field].choices&&this.control.params.fields[this.label.field].choices[t])t=this.control.params.fields[this.label.field].choices[t];else if(("radio"===this.control.params.fields[this.label.field].type||"radio-image"===this.control.params.fields[this.label.field].type)&&this.rowIndex>=0){let e=this.container.find(`${this.control.selector} [data-row="${this.rowIndex}"] .repeater-field [data-field="${this.label.field}"]:checked`)[0];e&&(t=e.value)}}this.header.find(".repeater-row-label").text(t);return}}}this.header.find(".repeater-row-label").text(`${this.label.value} ${this.rowIndex+1}`)},this.rowIndex=i,this.container=r,this.label=s,this.header=this.container.find(".repeater-row-header"),this.control=a,this.header.on("click",()=>this.toggleMinimize()),this.container.on("click",".repeater-row-remove",()=>this.remove()),this.header.on("mousedown",()=>this.container.trigger("row:start-dragging")),this.container.on("keyup change","input, select, textarea",i=>this.container.trigger("row:update",[this.rowIndex,e(t)(i.target).data("field"),i.target])),this.setRowIndex(this.rowIndex)}}var r={};r=_,wp.customize.controlConstructor["wpbf-repeater"]=wp.customize.Control.extend({ready:function(){this.initWpbfControl?.()},rows:[],currentIndex:0,repeaterFieldsContainer:void 0,settingField:void 0,repeaterTemplate:void 0,initWpbfControl:function(t){let i;let s=t||this,a=s.params.value;s.settingField=s.container.find("[data-customize-setting-link]").first(),s.setValue?.([],!1),s.repeaterFieldsContainer=s.container.find(".repeater-fields").first(),s.currentIndex=0,s.rows=[];let n=!1;if("number"==typeof s.params.limit&&(n=!(0>=s.params.limit)&&s.params.limit),s.container?.on("click","button.repeater-add",e=>{e.preventDefault(),!n||"number"==typeof s.currentIndex&&s.currentIndex<n?(i=s.addRow?.(),i?.toggleMinimize(),s.initColorPicker?.(),s.initSelect?.(i)):jQuery(s.selector+" .limit").addClass("highlight")}),s.container?.on("click",".repeater-row-remove",function(){"number"==typeof s.currentIndex&&s.currentIndex--,(!n||"number"==typeof s.currentIndex&&s.currentIndex<n)&&jQuery(s.selector+" .limit").removeClass("highlight")}),s.container?.on("click keypress",".repeater-field-image .upload-button,.repeater-field-cropped_image .upload-button,.repeater-field-upload .upload-button",function(e){e.preventDefault(),s.$thisButton=jQuery(this),s.openFrame?.(e)}),s.container?.on("click keypress",".repeater-field-image .remove-button,.repeater-field-cropped_image .remove-button",function(e){e.preventDefault(),s.$thisButton=jQuery(this),s.removeImage?.(e)}),s.container?.on("click keypress",".repeater-field-upload .remove-button",function(e){e.preventDefault(),s.$thisButton=jQuery(this),s.removeFile?.(e)}),s.repeaterTemplate=e(r).memoize(function(){let t={evaluate:/<#([\s\S]+?)#>/g,interpolate:/\{\{\{([\s\S]+?)\}\}\}/g,escape:/\{\{([^\}]+?)\}\}(?!\})/g,variable:"data"};return function(i){return e(r).template(s.container.find(".customize-control-repeater-content").first().html(),t)(i)}}),a.length){let e=0;for(e=0;e<a.length;e++)i=s.addRow?.(a[e]),s.initColorPicker?.(),s.initSelect?.(i,a[e])}s.repeaterFieldsContainer?.sortable({handle:".repeater-row-header",update:function(){s.sort?.()}})},openFrame:function(e){wp.customize.utils.isKeydownButNotEnterEvent(e)||(this.$thisButton?.closest(".repeater-field").hasClass("repeater-field-cropped_image")?this.initCropperFrame?.():this.initFrame?.(),this.frame.open())},initFrame:function(){let e=this.getMimeType();this.frame=wp.media({states:[new wp.media.controller.Library({library:wp.media.query({type:e}),multiple:!1,date:!1})]}),this.frame.on("select",this.onSelect,this)},initCropperFrame:function(){let t=this.$thisButton?.siblings("input.hidden-field").attr("data-field"),i=this.getMimeType();if(e(r).isString(t)&&""!==t&&e(r).isObject(this.params.fields[t])&&"cropped_image"===this.params.fields[t].type)for(let i of["width","height","flex_width","flex_height"])e(r).isUndefined(this.params.fields[t][i])||(this.params[i]=this.params.fields[t][i]);this.frame=wp.media({button:{text:"Select and Crop",close:!1},states:[new wp.media.controller.Library({library:wp.media.query({type:i}),multiple:!1,date:!1,suggestedWidth:this.params.width,suggestedHeight:this.params.height}),new wp.media.controller.CustomizeImageCropper({imgSelectOptions:this.calculateImageSelectOptions,control:this})]}),this.frame.on("select",this.onSelectForCrop,this),this.frame.on("cropped",this.onCropped,this),this.frame.on("skippedcrop",this.onSkippedCrop,this)},onSelect:function(){let e=this.frame.state().get("selection").first().toJSON();this.$thisButton?.closest(".repeater-field").hasClass("repeater-field-upload")?this.setFileInRepeaterField(e):this.setImageInRepeaterField(e)},onSelectForCrop:function(){let e=this.frame.state().get("selection").first().toJSON();this.params.width!==e.width||this.params.height!==e.height||this.params.flex_width||this.params.flex_height?this.frame.setState("cropper"):this.setImageInRepeaterField(e)},onCropped:function(e){this.setImageInRepeaterField(e)},calculateImageSelectOptions:function(e,t){let i,r;let s=t.get("control"),a=!!parseInt(s.params.flex_width,10),n=!!parseInt(s.params.flex_height,10),o=e.get("width"),l=e.get("height"),d=parseInt(s.params.width,10),h=parseInt(s.params.height,10),p=d/h;t.set("canSkipCrop",!s.mustBeCropped(a,n,d,h,o,l)),o/l>p?d=(h=l)*p:h=(d=o)/p,i=(o-d)/2,r=(l-h)/2;let c={handles:!0,keys:!0,instance:!0,persistent:!0,imageWidth:o,imageHeight:l,aspectRatio:"",maxHeight:!1,maxWidth:!1,x1:i,y1:r,x2:d+i,y2:h+r};return!1===n&&!1===a&&(c.aspectRatio=d+":"+h),!1===n&&(c.maxHeight=h),!1===a&&(c.maxWidth=d),c},mustBeCropped:function(e,t,i,r,s,a){return!(!0===e&&!0===t||!0===e&&r===a||!0===t&&i===s||i===s&&r===a||s<=i)},onSkippedCrop:function(){let e=this.frame.state().get("selection").first().toJSON();this.setImageInRepeaterField(e)},setImageInRepeaterField:function(e){let t=this.$thisButton?.closest(".repeater-field-image,.repeater-field-cropped_image");t?.find(".wpbf-image-attachment").html('<img src="'+e.url+'">').hide().slideDown("slow"),t?.find(".hidden-field").val(e.id),this.$thisButton?.text(this.$thisButton.data("alt-label")),t?.find(".remove-button").show(),t?.find("input, textarea, select").trigger("change"),this.frame.close()},setFileInRepeaterField:function(e){let t=this.$thisButton?.closest(".repeater-field-upload");t?.find(".wpbf-file-attachment").html('<span class="file"><span class="dashicons dashicons-media-default"></span> '+e.filename+"</span>").hide().slideDown("slow"),t?.find(".hidden-field").val(e.id),this.$thisButton?.text(this.$thisButton.data("alt-label")),t?.find(".upload-button").show(),t?.find(".remove-button").show(),t?.find("input, textarea, select").trigger("change"),this.frame.close()},getMimeType:function(){let t=this.$thisButton?.siblings("input.hidden-field").attr("data-field");return e(r).isString(t)&&""!==t&&e(r).isObject(this.params.fields[t])&&"upload"===this.params.fields[t].type&&!e(r).isUndefined(this.params.fields[t].mime_type)?this.params.fields[t].mime_type:"image"},removeImage:function(e){if(wp.customize.utils.isKeydownButNotEnterEvent(e))return;let t=this.$thisButton?.closest(".repeater-field-image,.repeater-field-cropped_image,.repeater-field-upload"),i=t?.find(".upload-button");t?.find(".wpbf-image-attachment").slideUp("fast",function(){jQuery(this).show().html(jQuery(this).data("placeholder"))}),t?.find(".hidden-field").val(""),i?.text(i.data("label")),this.$thisButton?.hide(),t?.find("input, textarea, select").trigger("change")},removeFile:function(e){if(wp.customize.utils.isKeydownButNotEnterEvent(e))return;let t=this.$thisButton?.closest(".repeater-field-upload"),i=t?.find(".upload-button");t?.find(".wpbf-file-attachment").slideUp("fast",function(){jQuery(this).show().html(jQuery(this).data("placeholder"))}),t?.find(".hidden-field").val(""),i?.text(i.data("label")),this.$thisButton?.hide(),t?.find("input, textarea, select").trigger("change")},getValue:function(){let e=this.setting?.get();return JSON.parse(decodeURI(void 0===e||"string"!=typeof e?"":e))},setValue:function(t,i,s){let a=[];if("custom_fonts"===this.id&&console.log(`newValue of ${this.id} in setValue:`,t),s){for(let e in this.params.fields)this.params.fields.hasOwnProperty(e)&&this.params.fields[e].type&&["image","cropped_image","upload"].includes(this.params.fields[e].type)&&a.push(e);jQuery.each(t,function(i,s){jQuery.each(a,function(a,n){e(r).isUndefined(s[n])||e(r).isUndefined(s[n].id)||(t[i][n]=s[n].id)})})}this.setting?.set(encodeURI(JSON.stringify(t))),i&&this.settingField?.trigger("change")},addRow:function(e){let t=this,r=this.getValue?.(),s={},a=t.repeaterTemplate?.();if(a){let n,o=jQuery.extend(!0,{},t.params.fields);if(e){let t;for(t in e)e.hasOwnProperty(t)&&o.hasOwnProperty(t)&&(o[t].default=e[t])}a=a(o);let l=new i(t.currentIndex??0,jQuery(a).appendTo(t.repeaterFieldsContainer),t.params.rowLabel,t);for(n in l.container.on("row:remove",function(e,i){t.deleteRow?.(i)}),l.container.on("row:update",function(e,i,r,s){"custom_fonts"===t.id&&console.log(`value of "${r}" in row:update for ${t.id} in addRow:`,s.value),t.updateField?.call(t,e,i,r,s),l.updateLabel?.()}),console.log("currentIndex",this.currentIndex),this.currentIndex&&this.rows&&(this.rows[this.currentIndex]=l),o)o.hasOwnProperty(n)&&(s[n]=o[n].default);return void 0!==this.currentIndex&&(r[this.currentIndex]=s),this.setValue?.(r,!0),void 0!==this.currentIndex&&this.currentIndex++,l}},sort:function(){let e=this,t=this.repeaterFieldsContainer?.find(".repeater-row"),i=[],r=e.getValue?.(),s=[],a=[];t?.each(function(e,t){i.push(jQuery(t).data("row"))}),jQuery.each(i,function(t,i){e.rows&&(s[t]=e.rows[i]),s[t].setRowIndex(t),a[t]=r[i]}),e.rows=s,e.setValue?.(a)},deleteRow:function(e){if(!this.rows)return;let t=this.getValue?.();for(let i in t[e]&&this.rows[e]&&(delete t[e],delete this.rows[e],this.setValue?.(t,!0)),this.rows)this.rows.hasOwnProperty(i)&&this.rows[i]&&this.rows[i].updateLabel()},updateField:function(t,i,s,a){if(!this.rows||!this.rows[i]||!this.params.fields[s])return;let n=this.params.fields[s].type,o=this.rows[i],l=this.getValue?.();"custom_fonts"===this.id&&console.log("currentSettings from updateField:",l);let d=jQuery(a);e(r).isUndefined(l[o.rowIndex][s])||("checkbox"===n?l[o.rowIndex][s]=d.is(":checked"):l[o.rowIndex][s]=d.val(),this.setValue?.(l,!0))},initColorPicker:function(){let t=this,i=t.container?.find(".wpbf-classic-color-picker"),s=i?.data("field"),a={};!e(r).isUndefined(s)&&!e(r).isUndefined(t.params.fields[s])&&!e(r).isUndefined(t.params.fields[s].palettes)&&e(r).isObject(t.params.fields[s].palettes)&&(a.palettes=t.params.fields[s].palettes),a.change=function(e,i){let r=jQuery(e.target),s=r.closest(".repeater-row").data("row"),a=t.getValue?.(),n=i.color._alpha<1?i.color.to_s():i.color.toString();a[s][r.data("field")]=n,t.setValue?.(a,!0),setTimeout(function(){e.target.value=n},50)},i&&i.length>0&&i.wpColorPicker(a)},initSelect:function(e,t){let i=this,r=e.container.find(".repeater-field select");if(0===r.length)return;let s=r.data("field");(t=t||{})[s]=t[s]||"",jQuery(r).val(t[s]||jQuery(r).val()),this.container.on("change",".repeater-field select",function(e){let t=jQuery(e.target),r=t.closest(".repeater-row").data("row"),s=i.getValue?.();s[r][t.data("field")]=jQuery(this).val(),i.setValue?.(s)})}})}();
//# sourceMappingURL=repeater-control-min.js.map
